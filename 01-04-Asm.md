# Class文件结构

class文件 使用 u1、u2、u4 表示1、2、4字节无符号整数，用table来表示数组对象，table由长度n+n个字节数组组成，一个字节数组就是一个对象。

```text
ClassFile {
    u4             magic;                                    //Class 文件的标志：魔数
    u2             minor_version;                            //Class 的次版本号
    u2             major_version;                            //Class 的主版本号
    u2             constant_pool_count;                      //常量池的数量
    cp_info        constant_pool[constant_pool_count-1];     //常量池
    u2             access_flags;                             //Class 的访问标志
    u2             this_class;                               //当前类
    u2             super_class;                              //父类
    u2             interfaces_count;                         //接口
    u2             interfaces[interfaces_count];             //一个类可以实现多个接口
    u2             fields_count;                             //Class 文件的字段属性
    field_info     fields[fields_count];                     //一个类会可以有个字段
    u2             methods_count;                            //Class 文件的方法数量
    method_info    methods[methods_count];                   //一个类可以有个多个方法
    u2             attributes_count;                         //此类的属性表中的属性数
    attribute_info attributes[attributes_count];             //属性表集合
}
```

`My Very Cute Animal Turns Savage In Full Moon Areas`
![438.png](assets/438.png)

## 常量池

常量池的索引从1开始，第0项是用于表示“不引用任何一个常量池项目”。

```text
cp_info {
    u1 tag;     // 常量项类型
    u1 info[];  // 字节数组
}
```

不同的常量类型字节数组布局不一样。

<table>
    <tr>
        <td>类型</td>
        <td>描述</td>
        <td>类型</td>
        <td>字段</td>
        <td>备注</td>
   </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_utf8_info</td>
  		 <td rowspan="3">MUTF8编码的字符串</td>
         <td>u1</td>
         <td>tag</td>
         <td>1</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>length</td>
        <td>长度</td>
    </tr>
    <tr>
        <td>u1</td>  
        <td>byte[length]</td>
        <td>字节数组</td>
    </tr>
    <tr>
  		 <td rowspan="2">CONSTANT_Integer_info</td>
  		 <td rowspan="2">整型字面量</td>
         <td>u1</td>
         <td>tag</td>
         <td>3</td> 
    </tr>
    <tr>
        <td>u4</td>  
        <td>byte[4]</td>
    </tr>
    <tr>
  		 <td rowspan="2">CONSTANT_Float_info</td>
  		 <td rowspan="2">浮点型字面量</td>
         <td>u1</td>
         <td>tag</td>
         <td>4</td> 
    </tr>
    <tr>
        <td>u4</td>  
        <td>byte[4]</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_Long_info</td>
  		 <td rowspan="3">长整型字面量</td>
         <td>u1</td>
         <td>tag</td>
         <td>5</td> 
    </tr>
    <tr>
        <td>u4</td>  
        <td>byte[4]</td>
        <td>高4位</td>
    </tr>
    <tr>
        <td>u4</td>  
        <td>byte[4]</td>
        <td>低4位</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_Double_info</td>
  		 <td rowspan="3">双精度浮点型字面量</td>
         <td>u1</td>
         <td>tag</td>
         <td>6</td> 
    </tr>
    <tr>
        <td>u4</td>  
        <td>byte[4]</td>
        <td>高4位</td>
    </tr>
    <tr>
        <td>u4</td>  
        <td>byte[4]</td>
        <td>低4位</td>
    </tr>
    <tr>
  		 <td rowspan="2">CONSTANT_Class_info</td>
  		 <td rowspan="2">类或接口的符号引用</td>
         <td>u1</td>
         <td>tag</td>
         <td>7</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_index</td>
        <td>指向全限定名常量项的索引，CONSTANT_utf8_info</td>
    </tr>
    <tr>
  		 <td rowspan="2">CONSTANT_String_info</td>
  		 <td rowspan="2">字符串类型字面量</td>
         <td>u1</td>
         <td>tag</td>
         <td>8</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_index</td>
        <td>指向字符串字面量的索引，CONSTANT_utf8_info</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_Fieldref_info</td>
  		 <td rowspan="3">字段的符号引用</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>9</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>class_index</td>
        <td>指向声明字段的类或者接口描述符，CONSTANT_Class_info</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_and_type_index</td>
        <td>指向字段描述符，CONSTANT_NameAndType</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_Methodref_info</td>
  		 <td rowspan="3">类中方法的符号引用</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>10</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>class_index</td>
        <td>指向声明字段的类或者接口描述符，CONSTANT_Class_info</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_and_type_index</td>
        <td>指向字段描述符，CONSTANT_NameAndType</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_InterfaceMethodref_info</td>
  		 <td rowspan="3">接口中方法的符号引用</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>11</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>class_index</td>
        <td>指向声明字段的类或者接口描述符，CONSTANT_Class_info</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_and_type_index</td>
        <td>指向字段描述符，CONSTANT_NameAndType</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_NameAndType_info</td>
  		 <td rowspan="3">字段或方法的部分符号引用</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>12</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_index</td>
        <td>指向该字段或方法名称，CONSTANT_utf8_info</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>descriptor_index</td>
        <td>指向该字段或方法描述符，CONSTANT_utf8_info</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_MethodHandle_info</td>
  		 <td rowspan="3">表示方法句柄</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>15</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>reference_kind</td>
        <td>方法句柄的类型，1-9</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>reference_index</td>
        <td>对常量池的有效索引，CONSTANT_utf8_info</td>
    </tr>
    <tr>
  		 <td rowspan="2">CONSTANT_MethodType_info</td>
  		 <td rowspan="2">标识方法类型</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>16</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>descriptor_index</td>
        <td>指向该字段或方法描述符，CONSTANT_utf8_info</td>
    </tr>
    <tr>
  		 <td rowspan="3">CONSTANT_InvokeDynamic_info</td>
  		 <td rowspan="3">动态方法调用点</td>
         <td>u1</td>
         <td>tag</td>
  		 <td>18</td> 
    </tr>
    <tr>
        <td>u2</td>  
        <td>bootstrap_method_attr_index</td>
        <td>对当前Class文件中引导方法表的bootstrap_methods[]，是一种特殊的attribute_infoattributes，BootstrapMethods Attribute</td>
    </tr>
    <tr>
        <td>u2</td>  
        <td>name_and_type_index</td>
        <td>方法名和方法描述符，CONSTANT_NameAndType</td>
    </tr>
</table>

### 字段描述符


| 描述符      | 类型                                 |
| ----------- | ------------------------------------ |
| B           | 基本类型byte                         |
| C           | 基本类型char                         |
| D           | 基本类型double                       |
| F           | 基本类型float                        |
| I           | 基本类型int                          |
| J           | 基本类型long                         |
| S           | 基本类型short                        |
| Z           | 基本类型boolean                      |
| LClassName; | 引用类型，"L"+对象类型的全限定名+";" |
| [           | 一维数组，多维数组使用多个[          |

### 方法描述符

格式：`(参数1类型参数2类型...)返回值类型`

例如：`Object foo(int i,double d,Thread t)` 描述符为 `(IDLjava/lang/Thread;)Ljava/lang/Object;`

## 访问标识

![439.png](assets/439.png)


| 标志名称       | 标志值 |
| -------------- | ------ |
| ACC_PUBLIC     | 0x0001 |
| ACC_FINAL      | 0x0010 |
| ACC_SUPER      | 0x0020 |
| ACC_INTERFACE  | 0x0200 |
| ACC_ABSTRACT   | 0x0400 |
| ACC_SYNTHETIC  | 0x1000 |
| ACC_ANNOTATION | 0x2000 |
| ACC_ENUM       | 0x4000 |

## 字段表

```text
field_info {
    u2 access_flags;                                // 访问标识
    u2 name_index;                                  // 字段名，引用 utf8 常量
    u2 descriptor_index;                            // 字段的描述符，引用 utf8 常量
    u2 attributes_count;
    attribute_info attributes[attributes_count];    // 字段的属性，例如 ConstantValue ，用来存 final关键字定义的常量值
}
```

### 访问标识

![440.png](assets/440.png)


| 标志名称      | 标志值 |
| ------------- | ------ |
| ACC_PUBLIC    | 0x0001 |
| ACC_PRIVATE   | 0x0002 |
| ACC_PROTECTED | 0x0004 |
| ACC_STATIC    | 0x0008 |
| ACC_FINAL     | 0x0010 |
| ACC_VOLATILE  | 0x0040 |
| ACC_TRANSIENT | 0x0080 |
| ACC_SYNTHETIC | 0x1000 |
| ACC_ENUM      | 0x4000 |

## 方法表

```text
field_info {
    u2 access_flags;                                // 访问标识
    u2 name_index;                                  // 方法名，引用 utf8 常量
    u2 descriptor_index;                            // 方法的描述符，引用 utf8 常量
    u2 attributes_count;
    attribute_info attributes[attributes_count];    // 方法的属性，例如 code 储存方法的代码内容，exceptions 储存方法声明抛出的异常
}
```

### 访问标识

![441.png](assets/441.png)


| 标志名称         | 标志值 |
| ---------------- | ------ |
| ACC_PUBLIC       | 0x0001 |
| ACC_PRIVATE      | 0x0002 |
| ACC_PROTECTED    | 0x0004 |
| ACC_STATIC       | 0x0008 |
| ACC_FINAL        | 0x0010 |
| ACC_SYNCHRONIZED | 0x0020 |
| ACC_BRIDGE       | 0x0040 |
| ACC_VARARGS      | 0x0080 |
| ACC_NATIVE       | 0x0100 |
| ACC_ABSTRACT     | 0x0400 |
| ACC_STRICTFP     | 0x0800 |
| ACC_SYNTHETIC    | 0x1000 |

## 属性表

属性表的类型较多，列举几类常见的属性：


| 属性                                 | 可用位置                                                | 含义                                                                                   |
| ------------------------------------ |-----------------------------------------------------| -------------------------------------------------------------------------------------- |
| SourceFile                           | ClassFile                                           | 记录源文件名称                                                                         |
| InnerClasses                         | ClassFile                                           | 内部类列表                                                                             |
| EnclosingMethod                      | ClassFile                                           | 仅当一个类为局部类或者匿名类时，才能拥有这个属性，这个属性用于表示这个类所在的外围方法 |
| BootstrapMethods                     | ClassFile                                           | JDK1.7新增的属性，用于保存invokedynamic指令引用的引导方法限定符                        |
| ConstantValue                        | field_info                                          | final关键字定义的常量值                                                                |
| Code                                 | method_info                                         | Java代码编译成的字节码指令                                                             |
| Exceptions                           | method_info                                         | 方法声明的异常                                                                         |
| RuntimeVisibleAnnotations            | ClassFile</br>field_info</br>method_info            | JDK1.5新增，指明哪些注解是运行时(实际上运行时就是进行反射调用)可见的                   |
| RuntimeInvisibleAnnotations          | ClassFile</br>field_info</br>method_info            | JDK1.5新增，指明哪些注解是运行时不可见的                                               |
| RuntimeVisibleParameterAnnotations   | method_info                                         | JDK1.5新增，指明哪些方法的参数注解是运行时可见的。                                     |
| RuntimeInvisibleParameterAnnotations | method_info                                         | JDK1.5新增，指明哪些方法的参数注解是运行时不可见的。                                   |
| AnnotationDefault                    | method_info                                         | JDK1.5新增，用于记录注解类元素的默认值                                                 |
| MethodParameters                     | method_info                                         | 52.0                                                                                   |
| Signature                            | ClassFile</br>field_info</br>method_info            | JDK1.5新增，支持泛型情况下的方法签名                                                   |
| LineNumberTable                      | Code                                                | Java源码的行号与字节码指令的对应关系                                                   |
| LocalVariableTable                   | Code                                                | 方法的局部变量描述                                                                     |
| LocalVariableTypeTable               | Code                                                | JDK1.5新增，使用特征签名代替描述符，描述泛型参数化类型而添加                           |
| StackMapTable                        | Code                                                | JDK1.6新增，检查和处理目标方法的局部变量和操作数栈所需要的类型是否匹配                 |
| MethodParameters                     | method_info                                         | JDK1.8新增，用于标识方法参数的名称和访问标志                                           |
| RuntimeVisibleTypeAnnotations        | ClassFile\</br\>field_info</br>method_info</br>Code | JDK1.8新增，在运行时可见的注释，用于泛型类型，指令等。                                 |
| RuntimeInvisibleTypeAnnotations      | ClassFile</br>field_info</br>method_info</br>Code   | JDK1.8新增，在编译时可见的注释，用于泛型类型，指令等。                                 |
